# MASHt - MASH toolkit

Python toolkit for the MASH tool for Linux.

## Description

This toolkit serves to automate work that includes MASH.

## Getting started

### Dependencies

- Python (tested on 3.10)
  - pandas
  - matplotlib
  - rpy2
  - statsmodels
- R
  - stats
  - broom
- mash (either in binary or installed in the environment)
- Linux OS

### Installation

No installation is necessary - the package should work right away.

## Executing the program

### mash module

- basic mash distance calculation (between the first and all of the rest of files in a specified directory):

    ```console
    foo@bar: python3 masht mash <path_to_dir> -d
    ```

    MASHt can also calculate distances between the first and the rest of specified files if `<path_to_dir>` is replaced with a `<path_to_file>`:

    ```console
    foo@bar: python3 masht mash <path_to_file> -d
    ```

    The `<path_to_file>` file should list filenames relative to current directory, e.g.:

    ``` txt
    tests/data/seqs/1.fastq
    tests/data/seqs/3.fastq
    tests/data/seqs/5.fastq
    ```

    NB - the `<path_to_file>` file has to have a .txt extension!
- basic mash sketching (of all files in the specified directory into one sketch):

    ```console
    foo@bar: python3 masht mash <path_to_dir> -s
    ```

- mash sketching, saving to specified folder and viewing information on these sketches:

    ```console
    foo@bar: python3 masht mash <path_to_dir> -s -i -o <output_dir>
    ```

- viewing info on all sketches in a folder:

    ```console
    foo@bar: python3 masht mash <path_to_dir> -i
    ```

- calculating distances between all sequences in a selected sketch (lower portion of the distance matrix) and printing it to console:

    ```console
    foo@bar: python3 masht mash <chosen_.msh_file> -t -v
    ```

- `--info` and `--triangle` options automatically work on the sketch file generated in the same command, e.g.:

    ```console
    foo@bar: python3 masht mash <dir_with_input_sequences> -s -t -i -o <output_dir>
    ```

    will create the sketch (.msh) file of all files within `dir_with_input_sequences/`, show information on them to the console and generate a `sketches_triangle.tsv` report file. The files will be stored in the `output_dir/`.
- parameters and options can be specified in a text file. Use `@<file_name>` to point to the file:

    ```console
    foo@bar: python3 masht mash @<file_name>
    ```

    `<file_name>` is relative to current directory, so:

    ```console
    foo@bar: python3 masht mash @test/args.txt
    ```

    will run masht mash with arguments provided in `args.txt` file within `./tests/` directory.
    `args.txt` should look something like this (note that there should be no trailing spaces on any of the lines!):

    ```text
    tests/data/seqs
    -s
    -o test_outputs
    -v
    ```

#### mash options (flags)

|option|long name|description|
|---|---|---|
|`-b`|`--bounds`|calculate Mash error bounds of selected files|
|`-d`|`--distance`|calculate mash distances between the first and all of the rest of selected files|
|`-h`|`--help`|show help message|
|`-i`|`--info`|show information on selected sketch files|
|`-m`|`--mash`|run mash with specified params (point to a mash binary in the beginning)|
|`-o`|`--output_dir`|location of output directory (default: '.')|
|`-s`|`--sketch`|create sketches of selected files|
|`-sc`|`--screen`|determine whether query sequences are within a sketch file|
|`-t`|`--triangle`|generate matrix of distances in a sketch|
|`-v`|`--verbose`|print more descriptions of performed actions to the console|

### stats module

- basic PCoA analysis:

    The simplest use case is to perform analysis on one triangle file generated by MASHt:

    ```console
    foo@bar: python3 masht stats <path_to_triangle_file> -p -o <output_dir>
    ```

    One can also perform PCoA analysis on all files within `<path_to_dir>`:

    ```console
    foo@bar: python3 masht stats <path_to_dir> -p -o <output_dir>
    ```

    MASHt can also perform PCoA analysis on specified files if `<path_to_dir>` is replaced with a `<path_to_file>`:

    ```console
    foo@bar: python3 masht stats <path_to_file> -p
    ```

    The `<path_to_file>` file should list filenames relative to current directory, e.g.:

    ``` txt
    tests/data/triangle_one.tsv
    tests/data/triangle_two.tsv
    tests/data/triangle_three.tsv
    ```

    NB - the `<path_to_file>` file has to have a .txt extension!

  - number of dimensions is controlled with the `-n` option. Give an intiger to specify the number of dimensions or leave it empty to perform PCoA analysis on all dimensions:

    ```console
    foo@bar: python3 masht stats <path_to_triangle_file> -p -n 4
    ```

- ANOVA/MANOVA analysis:

    ```console
    foo@bar: python3 masht stats <path_to_pcoa_coords_file> -a -g <path_to_groups_file>
    ```

    Names of observations in `<path_to_groups_file>` file should be the same as in `<path_to_pcoa_coords_file>` file. The file should look something like this:

    |Sample|Genotype|Temp|Time|
    |---|---|---|---|
    |BWOT1dR2|BW|OT|1d|
    |BWOT1dR1|BW|OT|1d|
    |BWOT1dR3|BW|OT|1d|
    |BWOT10dR1|BW|OT|10d|
    |BWOT10dR2|BW|OT|10d|
    |BWOT10dR3|BW|OT|10d|

  - `<path_to_pcoa_coords_file>` file is automatically inferred to be the results file of PCoA analysis is `-p` option was chosen, so there is no need to specify it explicitly. You still have to provide the `<path_to_groups_file>` file, though:

    ```console
    foo@bar: python3 masht stats <path_to_triangle_file> -p -a -g <path_to_groups_file>
    ```

    is equivalent to:

    ```console
    foo@bar: python3 masht stats <path_to_pcoa_coords_file> -a -g <path_to_groups_file>
    ```

    after the PCoA analysis is performed on `<path_to_triangle_file>` file.

    > NB. MANOVA analysis is performed using R via `rpy2` package to transpile code and objects (like dataframes) between R and Python. This makes the execution a bit slower, but testing showed that results of n-way MANOVA using `statsmodels` are not calculated correctly as of the time of writing this docs. Once the issue is resolved, the MANOVA analysis will be performed using statsmodels and execution time will improve.

- parameters and options can be specified in a text file. Use `@<file_name>` to point to the file:

    ```console
    foo@bar: python3 masht stats @test/args.txt
    ```

    The file should look something like this (note that there should be no trailing spaces on any of the lines!):

    ```txt
    tests/anova_tests/aov_triangle.tsv
    -p
    -v
    -o
    test_outputs/
    -d
    1
    9
    -ma
    tests/anova_tests/test_groups_file.tsv
    ```

    this analysis will perform PCoA analysis on `tests/anova_tests/aov_triangle.tsv` file, draw a plot with PC1 and PC9 on it, perform MANOVA analysis on the same file and print more descriptions of performed actions to the console.

#### stats options (flags)

|option|long name|description|
|---|---|---|
|`-a`|`--anova`|perfom ANOVA on selected files. NB – a file with grouping has to be provided with the `-g` flag|
|`-d`|`--draw_plot`|draw PCoA plot when performing PCoA analysis. Two integers that signify which PCs to plot are required|
|`-g`|`--groups_file`|location of the .tsv file with groups for ANOVA/ MANOVA analysis. Required if `-a` or `-ma` was selected|
|`-ma`|`--manova`|perform MANOVA analysis on selected files. NB – a file with grouping has to be provided with the `-g` flag|
|`-mo`|`--mode`|select which type of ANOVA to perform. Should be either 'n' (to perform ANOVA on all parameters), an integer (for m-way ANOVA where first m columns from the groups_file will be selected) or 'repeat' for ANOVA with repeats. Defaults to 'n'|
|`-n`|`-n_dimensions`|number of target dimensions for PCoA analysis|
|`-nt`|`--not_triangle`|signifies that the input file is NOT a triangle matrix (e.g. a distance matrix)|
|`-o`|`--output_dir`|location of output directory (default: '.')|
|`-p`|`--pcoa`|perform PCoA analysis on selected files|
|`-pc`|`--pcs`|number of PCs to analyse with ANOVA. Defaults to 4|
|`-ss`|`--ss_type`|type of sum of squares to use for ANOVA. Defaults to 2|
|`-v`|`--verbose`|print more descriptions of performed actions to the console|

## Help

To access help, run the package with either -h or --help, e.g.:

```console
foo@bar: python3 masht -h
```

To print help for specific subcommand, specify it in your command:

``` console
foo@bar: python3 masht mash -h
```
